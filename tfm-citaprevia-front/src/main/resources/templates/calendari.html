<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <title th:utext="#{calendari.titol} + ' - ' + ${subAplicacio?.dem ?: subAplicacio?.dec ?: ''}"></title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <style>
        .dia-disponible { 
            background-color: #d4edda; 
            cursor: pointer; 
            transition: background-color 0.2s;
        }
        .dia-disponible:hover { 
            background-color: #c3e6cb; 
        }
        .dia-no-disponible { 
            background-color: #f8d7da; 
            cursor: not-allowed;
        }
        .dia-actual { 
            font-weight: bold; 
            border: 2px solid #007bff; 
            background-color: #cce7ff !important;
        }
        .franja-lliure { 
            background-color: #d1ecf1; 
        }
        .franja-ocupada { 
            background-color: #f5c6cb; 
        }
        .calendari-cell {
            height: 80px;
            vertical-align: middle;
            border-radius: 5px;
        }
    </style>
</head>
<body class="bg-light">

    <!-- Header -->
    <th:block th:replace="~{common/header :: header}"></th:block>

    <!-- Contenido principal -->
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-10 col-lg-8">

                <!-- Título -->
                <div class="text-center mb-4">
                    <h2 class="text-primary" th:utext="#{calendari.titol}"></h2>
                    <h5 th:utext="#{calendari.mes} + ' ' + ${calendari.any}"></h5>
                </div>

                <!-- Tarjeta del calendario -->
                <div class="card shadow">
                    <div class="card-body p-4">

                        <!-- Errores -->
                        <th:block th:replace="~{common/errors :: errors(errors = ${errors})}" />

                        <!-- Calendario -->
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr>
                                        <th th:utext="#{dilluns}">Dl</th>
                                        <th th:utext="#{dimarts}">Dt</th>
                                        <th th:utext="#{dimecres}">Dc</th>
                                        <th th:utext="#{dijous}">Dj</th>
                                        <th th:utext="#{divendres}">Dv</th>
                                        <th th:utext="#{dissabte}">Ds</th>
                                        <th th:utext="#{diumenge}">Dg</th>
                                    </tr>
                                </thead>
									<tbody>
									    <!-- Bucle manual: 6 semanas (máximo) -->
									    <tr th:each="weekIndex : ${#numbers.sequence(0, 5)}">
											<td th:each="dayIndex : ${#numbers.sequence(0, 6)}"
											    th:with="index = ${weekIndex * 7 + dayIndex}, 
											             dia = ${index < #lists.size(calendari.dies) ? calendari.dies[index] : null}"
											    th:if="${index < #lists.size(calendari.dies)}"
											    class="calendari-cell"
											    th:classappend="${dia.disponible} ? 'dia-disponible' : 'dia-no-disponible'"
											    th:classappend="${#dates.format(#calendars.createToday(), 'dd/MM/yyyy') == #dates.format(#calendars.createCalendar(calendari.any, calendari.mes-1, dia.dia), 'dd/MM/yyyy')} ? 'dia-actual'"
											    th:onclick="${dia.disponible} ? 'mostrarFranges(' + ${dia.dia} + ')' : null"
											    th:text="${dia.dia}">
											    1
											</td>
									        <!-- Rellenar celdas vacías si la semana no está completa -->
									        <td th:each="emptyIndex : ${#numbers.sequence(#lists.size(#aggregates($currentRow)), 6)}"
									            class="calendari-cell bg-light">
									        </td>
									    </tr>
									</tbody>
                            </table>
                        </div>

                        <!-- Contenedor de franjas horarias -->
                        <div id="frangesContainer" class="mt-4" style="display: none;">
                            <h5 class="text-primary mb-3" th:utext="#{selecciona.hora}"></h5>
                            <div id="frangesList" class="row"></div>
                        </div>

                    </div>
                </div>

                <!-- Botón volver -->
                <div class="text-center mt-4">
                    <a th:href="@{'/public/' + ${subaplCoa}}"
                       class="btn btn-secondary me-2"
                       th:utext="#{tornar}">
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <th:block th:replace="~{common/footer :: footer}"></th:block>

    <!-- PASO 4: SCRIPT INTEGRADO -->
    <script th:inline="javascript">
        function mostrarFranges(dia) {
            const dies = /*[[ ${calendari.dies} ]]*/ [];
            const diaDto = dies.find(d => d.dia === dia);
            const container = document.getElementById('frangesContainer');
            const list = document.getElementById('frangesList');
            
            // Limpiar
            list.innerHTML = '';

            if (!diaDto || !diaDto.disponible || !diaDto.franges || diaDto.franges.length === 0) {
                list.innerHTML = '<div class="col-12"><div class="alert alert-warning">' + 
                                '[[#{no_franges_disponibles}]]' + 
                                '</div></div>';
            } else {
                diaDto.franges.forEach(function(f, index) {
                    const col = document.createElement('div');
                    col.className = 'col-md-3 col-sm-6 mb-2';
                    
                    const btn = document.createElement('button');
                    btn.className = 'btn w-100 ' + (f.lliure ? 'btn-success franja-lliure' : 'btn-danger franja-ocupada');
                    btn.disabled = !f.lliure;
                    btn.innerHTML = '<strong>' + f.horaInici + ' - ' + f.horaFi + '</strong>' +
                                   (f.lliure ? '<i class="fas fa-check ms-1"></i>' : 
                                              '<i class="fas fa-times ms-1"></i>');
                    
                    if (f.lliure) {
                        const mes = /*[[ ${calendari.mes} ]]*/ 1;
                        const any = /*[[ ${calendari.any} ]]*/ 2025;
                        const data = any + '-' + mes.toString().padStart(2, '0') + '-' + dia.toString().padStart(2, '0');
                        
                        btn.onclick = function() {
                            window.location.href = '/public/[[${subaplCoa}]]/hora' +
                                '?tipcitCon=[[ ${tipcitCon} ]]' +
                                '&agendaCon=' + f.agendaCon +
                                '&data=' + data +
                                '&hora=' + f.horaInici;
                        };
                    }
                    
                    col.appendChild(btn);
                    list.appendChild(col);
                });
            }
            
            container.style.display = 'block';
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // Cerrar al hacer clic fuera
        document.addEventListener('click', function(event) {
            const container = document.getElementById('frangesContainer');
            if (container.style.display === 'block' && !container.contains(event.target)) {
                container.style.display = 'none';
            }
        });
    </script>

</body>
</html>