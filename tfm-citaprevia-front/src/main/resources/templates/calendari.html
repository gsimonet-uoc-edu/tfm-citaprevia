<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <title th:text="#{calendari} + (${tipusCita != null ? ' - ' + tipusCita.dem : ' - Àrea Pública'})"></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body class="bg-light">
<th:block th:replace="~{common/header :: header(appName=${subAplicacio.dem})}"></th:block>
    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-lg-2 d-none d-lg-block">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0" th:text="#{filtres}">Filtres</h6>
                    </div>
                    <div class="card-body">
                        <p class="text-success"><i class="fas fa-square me-2"></i><span th:text="#{franja_lliure}">Cita lliure</span></p>
                        <p class="text-danger"><i class="fas fa-square me-2"></i><span th:text="#{franja_ocupada}">Cita ocupada</span></p>
                    </div>
                </div>
            </div>

            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" th:text="#{selecciona_data_hora} + ' - ' + ${tipusCita.dem}">Selecciona Data/Hora</h5>
                        <a th:href="@{'/public/' + ${subaplCoa}}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-home me-1"></i> <span th:text="#{tornar_index}">Tornar a l'inici</span>
                        </a>
                    </div>
                    <div class="card-body p-3">

                        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <span th:text="${succes}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
						<div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
						    <span th:text="${error}"></span> 
						    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
						</div>
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="reservaModal" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{'/public/' + ${subaplCoa} + '/reserva'}" method="post" id="formCita">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="reservaModalLabel" th:text="#{reserva_cita} + ' - ' + ${tipusCita.dem}">Reservar cita</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                                    
                        <input type="hidden" name="tipcitCon" th:value="${tipusCita.con}">
                        <input type="hidden" name="dataHoraInici" id="modalDataHoraInici">
                        <input type="hidden" name="dataHoraFin" id="modalDataHoraFin">
                        <input type="hidden" name="agendaCon" id="modalAgendaCon">
                        <div class="row g-3">
                            <div class="col-md-6"><label class="form-label" th:text="#{nom} + ' *'">Nom</label><input type="text" name="nom" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label" th:text="#{llis} + ' *'">Cognoms</label><input type="text" name="llis" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label" th:text="#{numdoc} + ' *'">DNI</label><input type="text" name="numdoc" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label" th:text="#{nomcar} + ' *'">Carrera</label><input type="text" name="nomcar" class="form-control" required></div>
                            <div class="col-md-6"><label class="form-label" th:text="#{tel} + ' *'">Telèfon</label><input type="text" name="tel" class="form-control" pattern="[0-9]{9}" required></div>
                            <div class="col-md-6"><label class="form-label" th:text="#{ema} + ' *'">Email</label><input type="email" name="ema" class="form-control" required></div>
                            <div class="col-12"><label class="form-label" th:text="#{obs}">Observacions</label><textarea name="obs" class="form-control" rows="3"></textarea></div>
                        </div>
                        <div class="row g-3 mt-4" th:if="${camposCita != null and !#lists.isEmpty(camposCita)}">
                            <h6 th:text="#{dades_adicionals}">Dades addicionals</h6>
                            <div th:each="campo : ${camposCita}" class="col-md-6">
                                <label class="form-label" th:text="${campo.label}"></label>
                                <div th:switch="${campo.type}">
                                    <input th:case="*" th:type="${campo.type}" th:name="'lit' + ${campoStat.count}" class="form-control"
                                           th:required="${#strings.contains(campo.validation, 'required')}"
                                           th:pattern="${#strings.contains(campo.validation, 'pattern') ? #strings.substringAfter(campo.validation, 'pattern=') : null}">
                                    <textarea th:case="textarea" th:name="'lit' + ${campoStat.count}" class="form-control" rows="3"
                                              th:required="${#strings.contains(campo.validation, 'required')}"></textarea>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 p-3 bg-light rounded">
                            <small class="text-muted"><i class="fas fa-clock me-1"></i><span th:text="#{hora_seleccionada}"></span>: <strong id="horaSeleccionada"></strong></small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{cancelar}">Cancel·lar</button>
                        <button type="submit" class="btn btn-success" th:text="#{reservar}">Reservar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="passadaModal" tabindex="-1" aria-labelledby="passadaModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title" id="passadaModalLabel"><i class="fas fa-exclamation-triangle me-2"></i> <span th:text="#{franja_passada}">Franja Passada</span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p th:text="#{missatge_franja_passada}">Ho sentim, aquesta franja horària ja ha passat i no es pot seleccionar per a una nova reserva.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-warning" data-bs-dismiss="modal" th:text="#{tancar}">Tancar</button>
                </div>
            </div>
        </div>
    </div>
    <th:block th:replace="~{common/footer :: footer}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales-all.global.min.js'></script> 
    
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const events = /*[[${frangesHorariesGrouped}]]*/ [];
            const reservaModal = new bootstrap.Modal(document.getElementById('reservaModal'));
            const passadaModal = new bootstrap.Modal(document.getElementById('passadaModal')); // Inicialització del nou modal

            // OBTENIR DATA I HORA ACTUALS PER RESTRICCIÓ
            const now = new Date(); // Data i hora actuals completes
            // Format ISO 8601 (YYYY-MM-DD) necessari per a validRange
            const todayISO = now.toISOString().slice(0, 10); 
            
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: /*[[${#locale.language}]]*/ 'ca',
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,timeGridWeek,timeGridDay' },
                slotMinTime: '08:00:00', slotMaxTime: '20:00:00', slotDuration: '00:30:00', slotLabelInterval: '00:30',
                allDaySlot: false, nowIndicator: true, height: 'auto',

                // **********************************************
                // RESTRICCIONS PER EVITAR DATES PASSADES
                // **********************************************
                
                // 1. Limita la data d'inici (no es pot navegar a res anterior a avui)
                validRange: { 
                    start: todayISO // Només permet des d'avui en endavant
                },
                
                // **********************************************
                // FI RESTRICCIONS
                // **********************************************

                events: Object.keys(events).flatMap(date => {
                    return events[date].map(event => {
                        const isLliure = event.lliure;
                        return {
                            start: event.start,
                            end: event.end || null,
                            classNames: isLliure ? 'hora-lliure' : 'hora-ocupada',
                            extendedProps: { lliure: isLliure, agendaCon: event.agendaCon, title: event.title, tecnicNom: event.tecnicNom, 
							                                tecnicLlinatge1: event.tecnicLl1, 
							                                centreNom: event.centreNom},
                            title: isLliure ? event.title : 'Ocupada'
                        };
                    });
                }),
                eventContent: function(info) {
                    const props = info.event.extendedProps;
                    if (props.lliure) {
						const nomCompletTecnic = `${props.tecnicNom} ${props.tecnicLlinatge1 || ''}`;
						const centre = props.centreNom || 'Sense ubicació';
						return { html: `
						                            <div class="event-title">${info.event.title}</div>
						                            <div class="event-subtitle">${nomCompletTecnic}</div>
						                            <div class="event-centre small text-muted">${centre}</div>
						                        ` };
                    } else {
                        return { html: `<div class="event-title">Ocupada</div>` };
                    }
                },
                eventDidMount: function(info) {
                    const props = info.event.extendedProps;
                    let tooltip = props.lliure 
                        ? `<strong>${info.event.title}</strong><br><small>${props.tecnicNom}</small>`
                        : `<em>Ocupada</em>`;
                    new bootstrap.Tooltip(info.el, { title: tooltip, html: true, placement: 'top', trigger: 'hover', container: 'body' });
                },
                eventClick: function(info) {
                    if (!info.event.extendedProps.lliure) return;

                    // OBTENIR DATA/HORA EN FORMAT LOCAL (NO UTC)
                    const offset = info.event.start.getTimezoneOffset() * 60000;
                    const startLocal = new Date(info.event.start.getTime() - offset).toISOString().slice(0, 19);
                    const endLocal = info.event.end ? new Date(info.event.end.getTime() - offset).toISOString().slice(0, 19) : '';

                    // 2. Comprovació addicional en el click per si la franja ja ha passat (Utilitza 'now' amb hora i minut)
                    if (new Date(info.event.start) < now) { 
                        passadaModal.show(); // MOSTRAR EL NOU MODAL EN LLOC DE L'ALERT
                        return;
                    }
                    
                    document.getElementById('modalDataHoraInici').value = startLocal;
                    document.getElementById('modalDataHoraFin').value = endLocal;
                    document.getElementById('modalAgendaCon').value = info.event.extendedProps.agendaCon;
                    document.getElementById('horaSeleccionada').textContent = info.event.title;
                    reservaModal.show();
                },
                loading: function(isLoading) { calendarEl.classList.toggle('opacity-50', isLoading); }
            });
            calendar.render();
        });
    </script>
</body>
</html>