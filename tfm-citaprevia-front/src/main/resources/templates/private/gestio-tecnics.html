<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <title th:text="#{gestio_tecnics}">Gestió de Tècnics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body class="bg-light">
    <th:block th:replace="~{common/header :: header}"></th:block>

    <div class="container py-4">
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2 class="mb-0" th:text="#{gestio_tecnics}">Gestió de Tècnics</h2>
            
            <a th:href="@{/private/gestio/horaris}" class="btn btn-secondary">
                <i class="fas fa-arrow-left me-2"></i> <span th:text="#{tornar_gestio_horaris}">Tornar a Horaris</span>
            </a>
        </div>
        
        <!-- Contenidor per a missatges d'alerta (éxit/error) -->
        <div id="alertContainer">
            <th:block th:if="${tecnicFormError}">
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <span th:text="${tecnicFormError}">Error de validació o de sistema.</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </th:block>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0" th:text="#{llista_tecnics}">Llista de Tècnics</h5>
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#tecnicModal" onclick="clearTecnicModal()">
                    <i class="fas fa-plus me-2"></i> <span th:text="#{nou_tecnic}">Nou Tècnic</span>
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th th:text="#{tecnic.coa}">COA</th>
                                <th th:text="#{tecnic.nom}">Nom</th>
                                <th th:text="#{tecnic.prf}">Perfil</th>
                                <th th:text="#{tecnic.ll1}">Lliure 1</th>
                                <th th:text="#{tecnic.ll2}">Lliure 2</th>
                                <th th:text="#{accions}">Accions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Llistat de Tècnics -->
                            <tr th:each="tecnic : ${tecnics}">
                                <td th:text="${tecnic.coa}"></td>
                                <td th:text="${tecnic.nom}"></td>
                                <td th:text="${tecnic.prf}"></td>
                                <td th:text="${tecnic.ll1}"></td>
                                <td th:text="${tecnic.ll2}"></td>
                                <td>
                                    <!-- Botó d'Edició: Ús segur de data-attributes (FIX PER ERROR DE SEGURETAT) -->
                                    <button type="button" 
                                            class="btn btn-sm btn-primary" 
                                            th:text="#{editar}"
                                            th:data-coa="${tecnic.coa}"
                                            th:data-nom="${tecnic.nom}"
                                            th:data-ll1="${tecnic.ll1}"
                                            th:data-ll2="${tecnic.ll2}"
                                            th:data-prf="${tecnic.prf}"
                                            onclick="editTecnic(this)">
                                        Editar
                                    </button>
                                    
                                    <!-- Botó d'Eliminació: Ús segur de data-attributes -->
                                    <button type="button" 
                                            class="btn btn-sm btn-danger" 
                                            th:text="#{esborrar}"
                                            th:data-coa="${tecnic.coa}"
                                            onclick="prepararEsborrarTecnic(this.dataset.coa)">
                                        Esborrar
                                    </button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(tecnics)}">
                                <td colspan="6" class="text-center" th:text="#{no_hi_ha_tecnics}">No hi ha tècnics registrats.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Modal d'Edició/Creació de Tècnic -->
        <div class="modal fade" id="tecnicModal" tabindex="-1" aria-labelledby="tecnicModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <form th:action="@{/private/gestio/tecnics}" method="post" id="formTecnic" th:object="${tecnicForm}">
                        <div class="modal-header">
                            <h5 class="modal-title" id="tecnicModalLabel" th:text="#{nou_tecnic}">Nou Tècnic</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            
                            <!-- Camp ocult per al COA original (útil per a l'edició, ja que COA pot ser clau primària) -->
                            <input type="hidden" id="originalCoa" name="originalCoa" value=""> 

                            <!-- Camp COA -->
                            <div class="mb-3">
                                <label for="coa" class="form-label" th:text="#{tecnic.coa}">COA</label>
                                <input type="text" class="form-control" id="coa" name="coa" th:field="*{coa}" required>
                                <div class="text-danger" th:if="${#fields.hasErrors('coa')}" th:errors="*{coa}">Error COA</div>
                            </div>
                            
                            <!-- Camp Nom -->
                            <div class="mb-3">
                                <label for="nom" class="form-label" th:text="#{tecnic.nom}">Nom</label>
                                <input type="text" class="form-control" id="nom" name="nom" th:field="*{nom}" required>
                                <div class="text-danger" th:if="${#fields.hasErrors('nom')}" th:errors="*{nom}">Error Nom</div>
                            </div>

                            <!-- Camp Contrasenya (només s'omple en creació o si es vol canviar) -->
                            <div class="mb-3">
                                <label for="pass" class="form-label" th:text="#{tecnic.pass}">Contrasenya</label>
                                <input type="password" class="form-control" id="pass" name="pass" th:field="*{pass}" th:required="${tecnicForm.coa == null or tecnicForm.coa.isEmpty()}">
                                <div class="text-muted small" th:text="#{tecnic.pass.tip}">Deixar buit per no canviar la contrasenya en edició.</div>
                                <div class="text-danger" th:if="${#fields.hasErrors('pass')}" th:errors="*{pass}">Error Contrasenya</div>
                            </div>
                            
                            <!-- Camp Perfil -->
                            <div class="mb-3">
                                <label for="prf" class="form-label" th:text="#{tecnic.prf}">Perfil (Ex: ADMIN, BASIC)</label>
                                <input type="text" class="form-control" id="prf" name="prf" th:field="*{prf}" required>
                                <div class="text-danger" th:if="${#fields.hasErrors('prf')}" th:errors="*{prf}">Error Perfil</div>
                            </div>

                            <!-- Camps Lliure -->
                            <div class="mb-3">
                                <label for="ll1" class="form-label" th:text="#{tecnic.ll1}">Lliure 1</label>
                                <input type="text" class="form-control" id="ll1" name="ll1" th:field="*{ll1}">
                                <div class="text-danger" th:if="${#fields.hasErrors('ll1')}" th:errors="*{ll1}">Error Lliure 1</div>
                            </div>
                            <div class="mb-3">
                                <label for="ll2" class="form-label" th:text="#{tecnic.ll2}">Lliure 2</label>
                                <input type="text" class="form-control" id="ll2" name="ll2" th:field="*{ll2}">
                                <div class="text-danger" th:if="${#fields.hasErrors('ll2')}" th:errors="*{ll2}">Error Lliure 2</div>
                            </div>
                            
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{cancelar}">Cancel·lar</button>
                            <button type="submit" class="btn btn-success" th:text="#{guardar}">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Modal d'Eliminació de Tècnic -->
        <div class="modal fade" id="esborrarTecnicModal" tabindex="-1" aria-labelledby="esborrarTecnicModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-sm">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" id="esborrarTecnicModalLabel" th:text="#{confirmar_esborrar}">Confirmar Eliminació</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p th:text="#{confirmar_esborrat_tecnic}">Està segur que vol esborrar aquest tècnic?</p>
                        <!-- Camp ocult per rebre el CON del tècnic a esborrar -->
                        <input type="hidden" id="esborrarTecnicCon" value="">
                    </div>
                    <div class="modal-footer justify-content-center">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{cancelar}">Cancel·lar</button>
                        <button type="button" class="btn btn-danger" onclick="deleteTecnic()" th:text="#{esborrar}">Esborrar</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <th:block th:replace="~{common/footer :: footer}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const API_URL = /*[[@{/api/private/tecnics}]]*/ '/api/private/tecnics';
        // Assume HORARI_CON is not strictly needed here, but keeping the context
        // const HORARI_CON = /*[[${horariCon}]]*/ ''; 
        
        // Funció per mostrar alertes
        function showAlert(message, type = 'success', containerId = 'alertContainer') {
            const container = document.getElementById(containerId);
            if (!container) return;
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            container.innerHTML = alertHtml;
        }

        /**
         * Buidar el modal i preparar-lo per a la creació d'un nou tècnic.
         */
        function clearTecnicModal() {
            document.getElementById('formTecnic').reset();
            document.getElementById('tecnicModalLabel').textContent = /*[[#{nou_tecnic}]]*/ 'Nou Tècnic';
            document.getElementById('originalCoa').value = ''; // Netejar el COA original
            document.getElementById('coa').readOnly = false; // El COA és editable en nou
            document.getElementById('pass').required = true; // La contrasenya és obligatòria en nou
        }

        /**
         * Carrega les dades del Tècnic seleccionat al modal d'edició llegint de data attributes.
         * La clau 'coa' es passa amb seguretat mitjançant data-attributes.
         * @param {HTMLElement} button - El botó d'edició clicat.
         */
        function editTecnic(button) {
            document.getElementById('tecnicModalLabel').textContent = /*[[#{editar_tecnic}]]*/ 'Editar Tècnic';

            // Llegir de data attributes
            const coa = button.dataset.coa;
            const nom = button.dataset.nom;
            const ll1 = button.dataset.ll1;
            const ll2 = button.dataset.ll2;
            const prf = button.dataset.prf;

            // 1. Carregar valors principals
            document.getElementById('coa').value = coa;
            document.getElementById('nom').value = nom;
            document.getElementById('ll1').value = ll1 || '';
            document.getElementById('ll2').value = ll2 || '';
            document.getElementById('prf').value = prf;
            
            // 2. Ajustos per a Edició
            document.getElementById('originalCoa').value = coa; // Guardar el COA original per a l'acció POST
            document.getElementById('coa').readOnly = true; // El COA no és editable en edició
            document.getElementById('pass').required = false; // La contrasenya no és obligatòria en edició
            document.getElementById('pass').value = ''; // Buidar el camp de contrasenya per defecte

            // 3. OBRIR EL MODAL
            var myModal = new bootstrap.Modal(document.getElementById('tecnicModal'));
            myModal.show();
        }

        /**
         * Funció per carregar el COA del tècnic al formulari ocult del modal d'eliminació.
         * @param {string} coa - El codi COA del tècnic.
         */
        function prepararEsborrarTecnic(coa) {
            // Carrega el COA al camp ocult del modal d'eliminació
            document.getElementById('esborrarTecnicCon').value = coa;
            var myModal = new bootstrap.Modal(document.getElementById('esborrarTecnicModal'));
            myModal.show();
        }

        /**
         * Elimina un tècnic mitjançant AJAX.
         */
        function deleteTecnic() {
            // Netejar missatges anteriors
            showAlert('', 'info', 'alertContainer'); 
            
            const tecnicCon = document.getElementById('esborrarTecnicCon').value;
            
            if (!tecnicCon) {
                showAlert(/*[[#{error_general}]]*/ 'Error: No s\'ha pogut obtenir el codi del tècnic.', 'danger');
                return;
            }

            // Tancar el modal d'eliminació
            bootstrap.Modal.getInstance(document.getElementById('esborrarTecnicModal')).hide();

            fetch(`${API_URL}/delete/${tecnicCon}`, { 
                method: 'POST', // O DELETE, segons el vostre disseny d'API
                headers: { 'Content-Type': 'application/json' }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { 
                        // Utilitzem 'dem' (demanda/descripció de l'error) si està disponible, o missatge genèric
                        const errorMessage = err.dem || /*[[#{error_eliminar_tecnic}]]*/ 'Error en eliminar el tècnic.';
                        throw new Error(errorMessage); 
                    });
                }
                return response.text(); 
            })
            .then(() => {
                showAlert(/*[[#{tecnic_esborrat_ok}]]*/ 'Tècnic esborrat correctament.', 'success');
                // Recarregar la pàgina o la llista per reflectir els canvis
                window.location.reload(); 
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert(error.message, 'danger');
            });
        }
        
        // Si hi ha errors de validació en el model, obrir el modal automàticament
        window.onload = function() {
            const hasErrors = document.querySelector('.text-danger[th\\:if]');
            const isEditing = document.getElementById('originalCoa') && document.getElementById('originalCoa').value !== '';
            
            if (hasErrors) {
                // Si hi ha errors, el modal s'ha d'obrir.
                const myModal = new bootstrap.Modal(document.getElementById('tecnicModal'));
                myModal.show();
                
                // Si el formulari era d'edició (tenia un COA), ajustem el mode.
                if (isEditing) {
                    document.getElementById('tecnicModalLabel').textContent = /*[[#{editar_tecnic}]]*/ 'Editar Tècnic';
                    document.getElementById('coa').readOnly = true;
                    document.getElementById('pass').required = false;
                } else {
                    document.getElementById('coa').readOnly = false;
                    document.getElementById('pass').required = true;
                }
            }
        };

        /*]]>*/
    </script>
</body>
</html>