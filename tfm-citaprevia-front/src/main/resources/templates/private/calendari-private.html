<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <title th:text="#{calendari_privat}"></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body class="bg-light">
    <th:block th:replace="~{common/header :: header}"></th:block>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar (leyenda) -->
            <div class="col-lg-2 d-none d-lg-block">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0" th:text="#{filtres}"></h6>
                    </div>
                    <div class="card-body">
                        <p class="text-success"><i class="fas fa-square me-2"></i><span th:text="#{franja_lliure}"></span></p>
                        <p class="text-danger"><i class="fas fa-square me-2"></i><span th:text="#{franja_ocupada}"></span></p>
                    </div>
                </div>
            </div>

            <!-- Calendario -->
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" th:text="#{calendari_privat}"></h5>
                        <div>
                            <span class="badge bg-light text-dark me-2" th:text="${tecnic.nom}"></span>
                            <a th:href="@{'/public/' + ${subaplCoa}}" class="btn btn-sm btn-outline-light">
                                <i class="fas fa-home me-1"></i> <span th:text="#{tornar_index}"></span>
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-3">
                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <th:block th:replace="~{common/footer :: footer}"></th:block>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const events = /*[[${frangesHorariesGrouped}]]*/ [];

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: /*[[${#locale.language}]]*/ 'ca',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                slotDuration: '00:30:00',
                slotLabelInterval: '00:30',
                allDaySlot: false,
                nowIndicator: true,
                height: 'auto',

                // === GENERAR EVENTOS ===
                events: Object.keys(events).flatMap(date => {
                    return events[date].map(event => {
                        const isLliure = event.lliure === true;
                        const nom = (event.nom || '').trim();
                        const llis = (event.llis || '').trim();
                        const nomComplet = (nom && llis) ? `${nom} ${llis}` : (nom || llis || 'Ocupada');

                        return {
                            start: event.start,
                            classNames: isLliure ? 'hora-lliure' : 'hora-ocupada',
                            extendedProps: {
                                lliure: isLliure,
                                agendaCon: event.agendaCon,
                                tipcitCon: event.tipcitCon,
                                citaCon: event.citaCon || null,
                                nom: nom,
                                llis: llis,
                                numdoc: event.numdoc || '',
                                nomcar: event.nomcar || '',
                                tel: event.tel || '',
                                ema: event.ema || '',
                                obs: event.obs || '',
                                lit1: event.lit1 || '',
                                lit2: event.lit2 || '',
                                lit3: event.lit3 || '',
                                lit4: event.lit4 || '',
                                lit5: event.lit5 || '',
                                lit6: event.lit6 || '',
                                lit7: event.lit7 || '',
                                lit8: event.lit8 || '',
                                lit9: event.lit9 || '',
                                lit10: event.lit10 || '',
                                tecnic: event.tecnic || 'TÃ¨cnic'
                            },
                            title: isLliure ? event.title : nomComplet
                        };
                    });
                }),

                // === RENDERIZADO PERSONALIZADO ===
                eventContent: function(info) {
                    const props = info.event.extendedProps;
                    if (props.lliure) {
                        return { 
                            html: `<div class="event-title">${info.event.title}</div><div class="event-subtitle">${props.tecnic}</div>` 
                        };
                    } else {
                        return { 
                            html: `<div class="event-title">${info.event.title}</div>` 
                        };
                    }
                },

                // === TOOLTIP ===
                eventDidMount: function(info) {
                    const props = info.event.extendedProps;
                    let tooltip = '';
                    if (props.lliure) {
                        tooltip = `<strong>${info.event.title}</strong><br><small>${props.tecnic}</small>`;
                    } else {
                        tooltip = `<div class="tooltip-cita">
                            <strong>${props.nom} ${props.llis}</strong><br>
                            <small>${props.numdoc} | ${props.nomcar}</small><br>
                            <small><i class="fas fa-phone"></i> ${props.tel} | <i class="fas fa-envelope"></i> ${props.ema}</small>`;
                        if (props.obs) tooltip += `<hr><small><em>${props.obs}</em></small>`;
                        for (let i = 1; i <= 10; i++) {
                            const lit = props['lit' + i];
                            if (lit) tooltip += `<br><small><strong>L${i}:</strong> ${lit}</small>`;
                        }
                        tooltip += `</div>`;
                    }
                    new bootstrap.Tooltip(info.el, { 
                        title: tooltip, 
                        html: true, 
                        placement: 'top', 
                        trigger: 'hover', 
                        container: 'body' 
                    });
                },

                // === CLIC EN EVENTO ===
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    if (props.lliure) {
                        window.location.href = `/private/cita/alta?agendaCon=${props.agendaCon}&start=${encodeURIComponent(info.event.start.toISOString())}`;
                    } else {
                        window.location.href = `/private/cita/detalle/${props.citaCon}`;
                    }
                },

                loading: function(isLoading) {
                    calendarEl.classList.toggle('opacity-50', isLoading);
                }
            });
            calendar.render();
        });
    lint
    </script>
</body>
</html>