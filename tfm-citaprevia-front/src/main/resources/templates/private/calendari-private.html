<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" th:lang="${#locale.language}">
<head>
    <meta charset="UTF-8">
    <title th:text="#{calendari_privat}"></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
    <link th:href="@{/css/style.css}" rel="stylesheet">
</head>
<body class="bg-light">
    <th:block th:replace="~{common/header :: header}"></th:block>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Sidebar (leyenda) -->
            <div class="col-lg-2 d-none d-lg-block">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0" th:text="#{filtres}"></h6>
                    </div>
                    <div class="card-body">
                        <p class="text-success"><i class="fas fa-square me-2"></i><span th:text="#{franja_lliure}"></span></p>
                        <p class="text-danger"><i class="fas fa-square me-2"></i><span th:text="#{franja_ocupada}"></span></p>
                    </div>
                </div>
            </div>

            <!-- Calendario -->
            <div class="col-lg-10">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="mb-0" th:text="#{calendari_privat}"></h5>
                        <div>
                            <span class="badge bg-light text-dark me-2" th:text="${tecnic.nom}"></span>
                            <a th:href="@{'/public/' + ${subaplCoa}}" class="btn btn-sm btn-outline-light">
                                <i class="fas fa-home me-1"></i> <span th:text="#{tornar_index}"></span>
                            </a>
                        </div>
                    </div>
                    <div class="card-body p-3">

                        <!-- ALERTAS FLASH -->
                        <div th:if="${success}" class="alert alert-success alert-dismissible fade show" role="alert">
                            <span th:text="#{cita_creada_ok}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        <div th:if="${error}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <span th:text="#{error_guardar_cita}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <div id="calendar"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DE RESERVA -->
    <div class="modal fade" id="reservaModalPrivate" tabindex="-1" aria-labelledby="reservaModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <form th:action="@{'/private/cita/reserva'}" method="post" id="formCitaPrivate">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title" id="reservaModalLabel" th:text="#{reserva_cita}"></h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="agendaCon" id="modalAgendaConPrivate">
                        <input type="hidden" name="dataHoraInici" id="modalDataHoraIniciPrivate">
                        <input type="hidden" name="dataHoraFin" id="modalDataHoraFinPrivate">

                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label" th:text="#{nom} + ' *'"></label>
                                <input type="text" name="nom" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" th:text="#{llis} + ' *'"></label>
                                <input type="text" name="llis" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" th:text="#{numdoc} + ' *'"></label>
                                <input type="text" name="numdoc" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" th:text="#{nomcar} + ' *'"></label>
                                <input type="text" name="nomcar" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" th:text="#{tel} + ' *'"></label>
                                <input type="text" name="tel" class="form-control" pattern="[0-9]{9}" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label" th:text="#{ema} + ' *'"></label>
                                <input type="email" name="ema" class="form-control" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label" th:text="#{obs}"></label>
                                <textarea name="obs" class="form-control" rows="3"></textarea>
                            </div>
                        </div>

                        <!-- CAMPOS DINÁMICOS -->
                        <div class="row g-3 mt-4" th:if="${camposCita != null and !#lists.isEmpty(camposCita)}">
                            <h6 th:text="#{dades_adicionals}"></h6>
                            <div th:each="campo : ${camposCita}" class="col-md-6">
                                <label class="form-label" th:text="${campo.label}"></label>
                                <div th:switch="${campo.type}">
                                    <input th:case="*" th:type="${campo.type}" th:name="'lit' + ${campoStat.count}" class="form-control"
                                           th:required="${#strings.contains(campo.validation, 'required')}"
                                           th:pattern="${#strings.contains(campo.validation, 'pattern') ? #strings.substringAfter(campo.validation, 'pattern=') : null}">
                                    <textarea th:case="textarea" th:name="'lit' + ${campoStat.count}" class="form-control" rows="3"
                                              th:required="${#strings.contains(campo.validation, 'required')}"></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="mt-4 p-3 bg-light rounded">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                <span th:text="#{hora_seleccionada}"></span>: <strong id="horaSeleccionadaPrivate"></strong>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" th:text="#{cancelar}"></button>
                        <button type="submit" class="btn btn-success" th:text="#{reservar}"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <th:block th:replace="~{common/footer :: footer}"></th:block>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <script th:inline="javascript">
        document.addEventListener('DOMContentLoaded', function() {
            const calendarEl = document.getElementById('calendar');
            const events = /*[[${frangesHorariesGrouped}]]*/ [];
            const modal = new bootstrap.Modal(document.getElementById('reservaModalPrivate'));

            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: /*[[${#locale.language}]]*/ 'ca',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                slotMinTime: '08:00:00',
                slotMaxTime: '20:00:00',
                slotDuration: '00:30:00',
                slotLabelInterval: '00:30',
                allDaySlot: false,
                nowIndicator: true,
                height: 'auto',

                events: Object.keys(events).flatMap(date => {
                    return events[date].map(event => {
                        const isLliure = event.lliure === true;
                        const nom = (event.nom || '').trim();
                        const llis = (event.llis || '').trim();
                        const nomComplet = (nom && llis) ? `${nom} ${llis}` : (nom || llis || 'Ocupada');

                        return {
                            start: event.start,
                            end: event.end, // ← IMPORTANTE: incluye end
                            classNames: isLliure ? 'hora-lliure' : 'hora-ocupada',
                            extendedProps: {
                                lliure: isLliure,
                                agendaCon: event.agendaCon,
                                tipcitCon: event.tipcitCon,
                                citaCon: event.citaCon || null,
                                nom: nom,
                                llis: llis,
                                numdoc: event.numdoc || '',
                                nomcar: event.nomcar || '',
                                tel: event.tel || '',
                                ema: event.ema || '',
                                obs: event.obs || '',
                                lit1: event.lit1 || '',
                                lit2: event.lit2 || '',
                                lit3: event.lit3 || '',
                                lit4: event.lit4 || '',
                                lit5: event.lit5 || '',
                                lit6: event.lit6 || '',
                                lit7: event.lit7 || '',
                                lit8: event.lit8 || '',
                                lit9: event.lit9 || '',
                                lit10: event.lit10 || '',
                                tecnic: event.tecnic || 'Tècnic'
                            },
                            title: isLliure ? event.title : nomComplet
                        };
                    });
                }),

                eventContent: function(info) {
                    const props = info.event.extendedProps;
                    if (props.lliure) {
                        return { 
                            html: `<div class="event-title">${info.event.title}</div><div class="event-subtitle">${props.tecnic}</div>` 
                        };
                    } else {
                        return { 
                            html: `<div class="event-title">${info.event.title}</div>` 
                        };
                    }
                },

                eventDidMount: function(info) {
                    const props = info.event.extendedProps;
                    let tooltip = '';
                    if (props.lliure) {
                        tooltip = `<strong>${info.event.title}</strong><br><small>${props.tecnic}</small>`;
                    } else {
                        tooltip = `<div class="tooltip-cita">
                            <strong>${props.nom} ${props.llis}</strong><br>
                            <small>${props.numdoc} | ${props.nomcar}</small><br>
                            <small><i class="fas fa-phone"></i> ${props.tel} | <i class="fas fa-envelope"></i> ${props.ema}</small>`;
                        if (props.obs) tooltip += `<hr><small><em>${props.obs}</em></small>`;
                        for (let i = 1; i <= 10; i++) {
                            const lit = props['lit' + i];
                            if (lit) tooltip += `<br><small><strong>L${i}:</strong> ${lit}</small>`;
                        }
                        tooltip += `</div>`;
                    }
                    new bootstrap.Tooltip(info.el, { 
                        title: tooltip, 
                        html: true, 
                        placement: 'top', 
                        trigger: 'hover', 
                        container: 'body' 
                    });
                },

                // EVENTCLICK CORREGIDO: USA info.event.end
                eventClick: function(info) {
                    const props = info.event.extendedProps;
                    if (!props.lliure) {
                        if (props.citaCon) {
                            window.location.href = `/private/cita/detalle/${props.citaCon}`;
                        }
                        return;
                    }

                    // FRANJA LIBRE → ABRIR MODAL
                    const offset = info.event.start.getTimezoneOffset() * 60000;
                    const startLocal = new Date(info.event.start.getTime() - offset).toISOString().slice(0, 19);

                    // USAR end SI EXISTE
                    let endLocal = startLocal;
                    if (info.event.end) {
                        endLocal = new Date(info.event.end.getTime() - offset).toISOString().slice(0, 19);
                    }

                    document.getElementById('modalAgendaConPrivate').value = props.agendaCon;
                    document.getElementById('modalDataHoraIniciPrivate').value = startLocal;
                    document.getElementById('modalDataHoraFinPrivate').value = endLocal;
                    document.getElementById('horaSeleccionadaPrivate').textContent = info.event.title;

                    modal.show();
                },

                loading: function(isLoading) {
                    calendarEl.classList.toggle('opacity-50', isLoading);
                }
            });
            calendar.render();
        });
    </script>
</body>
</html>